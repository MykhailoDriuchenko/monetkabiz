<%- include("partials/header", { title: "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞" }) %>

<div class="checkout-wrapper">
  <div class="checkout-container">
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ -->
    <div class="order-summary">
      <h3>–í–∞—à –∑–∞–∫–∞–∑</h3>
      <div class="product-card">
        <div class="product-image">
          <% if (ad.images && ad.images.length > 0) { %>
            <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é -->
            <img src="<%= ad.images[0].startsWith('http') ? ad.images[0] : '/uploads/' + ad.images[0] %>" alt="<%= ad.title %>" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="no-image" style="display: none;">üì∑</div>
          <% } else { %>
            <div class="no-image">üì∑</div>
          <% } %>
        </div>
        <div class="product-info">
          <h4><%= ad.title %></h4>
          <p class="product-price"><%= ad.price %>‚Ç¥</p>
        </div>
      </div>
      
      <div class="order-total">
        <div class="total-line">
          <span>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞:</span>
          <span><%= ad.price %>‚Ç¥</span>
        </div>
        <div class="total-line final-total">
          <span>–ò—Ç–æ–≥–æ:</span>
          <span><%= ad.price %>‚Ç¥</span>
        </div>
      </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ -->
    <div class="checkout-form">
      <div class="form-header">
        <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
        <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏</p>
      </div>

      <form action="/checkout/<%= ad._id %>" method="POST" id="checkout-form">
        <div class="form-section">
          <h4>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
          <div class="form-group">
            <label>–§–ò–û *</label>
            <input type="text" name="fullname" required placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
          </div>

          <div class="form-group">
            <label>Email *</label>
            <input type="email" name="email" required placeholder="example@mail.com">
          </div>

          <div class="form-group">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
            <input type="tel" name="phone" required placeholder="+380 (XX) XXX-XX-XX">
          </div>
        </div>

        <div class="form-section">
          <h4>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
          <div class="form-group">
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
            <textarea name="comment" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–≤—è–∂–∏—Ç–µ—Å—å —Å–æ –º–Ω–æ–π –ø–æ—Å–ª–µ 18:00, –æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∫ –¥–æ—Å—Ç–∞–≤–∫–µ..."></textarea>
            <span class="help-text">–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ</span>
          </div>
        </div>

        <div class="form-actions">
          <a href="/ad/<%= ad._id %>" class="btn-back">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–æ–≤–∞—Ä—É</a>
          <button type="submit" class="btn-submit">
            <span class="btn-text">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</span>
            <span class="btn-price"><%= ad.price %>‚Ç¥</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
<div id="toast" class="toast-notification"></div>

<style>
  :root {
    --primary-color: #4b5dff;
    --primary-hover: #3a4ae0;
    --success-color: #33cc6f;
    --error-color: #ff4757;
    --background-dark: #121212;
    --card-bg: #1e1e1e;
    --card-border: #2d2d2d;
    --text-primary: #ffffff;
    --text-secondary: #cccccc;
    --text-muted: #888888;
    --border-radius: 12px;
    --shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    --transition: all 0.3s ease;
  }

  .checkout-wrapper {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 80vh;
    padding: 40px 20px;
    background: var(--background-dark);
  }

  .checkout-container {
    display: grid;
    grid-template-columns: 1fr 1.2fr;
    gap: 30px;
    max-width: 1000px;
    width: 100%;
  }

  /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
  .order-summary,
  .checkout-form {
    background: var(--card-bg);
    padding: 30px;
    border-radius: var(--border-radius);
    border: 1px solid var(--card-border);
    box-shadow: var(--shadow);
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ */
  .order-summary h3,
  .checkout-form h2 {
    color: var(--text-primary);
    margin-bottom: 20px;
    font-size: 24px;
  }

  .product-card {
    display: flex;
    gap: 15px;
    padding: 20px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: var(--border-radius);
    margin-bottom: 25px;
  }

  .product-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
    position: relative;
  }

  .product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .no-image {
    width: 100%;
    height: 100%;
    background: #2a2a2a;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    border-radius: 8px;
  }

  .product-info h4 {
    color: var(--text-primary);
    margin: 0 0 8px 0;
    font-size: 16px;
  }

  .product-price {
    color: var(--success-color);
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }

  .order-total {
    border-top: 1px solid var(--card-border);
    padding-top: 20px;
  }

  .total-line {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    color: var(--text-secondary);
  }

  .final-total {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--card-border);
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã */
  .form-header {
    margin-bottom: 30px;
  }

  .form-header p {
    color: var(--text-secondary);
    margin: 0;
  }

  .form-section {
    margin-bottom: 30px;
  }

  .form-section h4 {
    color: var(--text-primary);
    margin-bottom: 20px;
    font-size: 18px;
    font-weight: 600;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    color: var(--text-secondary);
    margin-bottom: 8px;
    font-weight: 500;
    font-size: 14px;
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 14px 16px;
    border-radius: 8px;
    border: 1px solid #3a3a3a;
    background: #2a2a2a;
    color: var(--text-primary);
    font-size: 16px;
    transition: var(--transition);
    box-sizing: border-box;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(75, 93, 255, 0.1);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
    font-family: inherit;
  }

  .help-text {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 5px;
    display: block;
  }

  /* –ö–Ω–æ–ø–∫–∏ */
  .form-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    margin-top: 30px;
  }

  .btn-back {
    color: var(--text-secondary);
    text-decoration: none;
    padding: 12px 20px;
    border-radius: 8px;
    transition: var(--transition);
  }

  .btn-back:hover {
    color: var(--text-primary);
    background: rgba(255, 255, 255, 0.1);
  }

  .btn-submit {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 16px 24px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    flex-shrink: 0;
  }

  .btn-submit:hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
  }

  .btn-price {
    background: rgba(0, 0, 0, 0.2);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
  }

  /* Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
  .toast-notification {
    visibility: hidden;
    min-width: 280px;
    margin-left: -140px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 8px;
    padding: 16px;
    position: fixed;
    z-index: 1000;
    left: 50%;
    bottom: 30px;
    font-size: 14px;
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateY(20px);
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
  @media (max-width: 768px) {
    .checkout-container {
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    .checkout-wrapper {
      padding: 20px 15px;
    }
    
    .order-summary,
    .checkout-form {
      padding: 20px;
    }
    
    .form-actions {
      flex-direction: column;
      gap: 15px;
    }
    
    .btn-submit {
      width: 100%;
      justify-content: space-between;
    }
  }

  /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .checkout-container {
    animation: slideIn 0.6s ease-out;
  }
</style>

<script>
  const form = document.getElementById('checkout-form');
  const toast = document.getElementById('toast');

  function showToast(message, type = 'info') {
    toast.textContent = message;
    toast.style.visibility = "visible";
    toast.style.opacity = "1";
    toast.style.transform = "translateY(0)";
    
    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.transform = "translateY(20px)";
      setTimeout(() => {
        toast.style.visibility = "hidden";
      }, 300);
    }, 3000);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = form.querySelector('.btn-submit');
    const originalText = submitBtn.innerHTML;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    submitBtn.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
    submitBtn.disabled = true;

    const formData = new FormData(form);
    const data = new URLSearchParams();
    for (const pair of formData) {
      data.append(pair[0], pair[1]);
    }

    try {
      const res = await fetch(form.action, {
        method: 'POST',
        body: data
      });

      if (res.ok) {
        showToast("‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.", 'success');
        form.reset();
        setTimeout(() => { window.location.href = "/"; }, 2000);
      } else {
        const text = await res.text();
        showToast("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.", 'error');
      }
    } catch (err) {
      showToast("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.", 'error');
    } finally {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  });

   // –£–ª—É—á—à–µ–Ω–Ω–∞—è –º–∞—Å–∫–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  const phoneInput = document.querySelector('input[name="phone"]');
  
  phoneInput.addEventListener('focus', function() {
    if (!this.value) {
      this.value = '+38';
    }
  });
  
  phoneInput.addEventListener('input', function(e) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
    const cursorPosition = this.selectionStart;
    
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ –ø–ª—é—Å–∞ –≤ –Ω–∞—á–∞–ª–µ
    let value = this.value;
    let hasPlus = value.startsWith('+');
    let digits = value.replace(/\D/g, '');
    
    // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å +, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
    if (hasPlus) {
      digits = digits.startsWith('38') ? digits : '38' + digits;
      value = '+' + digits;
    } else {
      // –ï—Å–ª–∏ –Ω–µ—Ç –ø–ª—é—Å–∞, –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–¥ –£–∫—Ä–∞–∏–Ω—ã
      digits = digits.startsWith('38') ? digits : '38' + digits;
      value = '+' + digits;
    }
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É (–∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã + 9 —Ü–∏—Ñ—Ä)
    if (value.length > 13) {
      value = value.substring(0, 13);
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä: +38 XXX XXX XX XX
    let formattedValue = value;
    if (value.length > 3) {
      formattedValue = value.substring(0, 3) + ' ' + value.substring(3);
    }
    if (value.length > 6) {
      formattedValue = formattedValue.substring(0, 7) + ' ' + formattedValue.substring(7);
    }
    if (value.length > 9) {
      formattedValue = formattedValue.substring(0, 11) + ' ' + formattedValue.substring(11);
    }
    if (value.length > 12) {
      formattedValue = formattedValue.substring(0, 14) + ' ' + formattedValue.substring(14);
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    this.value = formattedValue;
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞ —Å —É—á–µ—Ç–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
    const addedChars = formattedValue.length - value.length;
    this.setSelectionRange(cursorPosition + addedChars, cursorPosition + addedChars);
  });
  
  phoneInput.addEventListener('keydown', function(e) {
    // –†–∞–∑—Ä–µ—à–∞–µ–º: backspace, delete, tab, escape, enter
    if ([46, 8, 9, 27, 13].includes(e.keyCode) || 
        // –†–∞–∑—Ä–µ—à–∞–µ–º: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
        (e.keyCode == 65 && e.ctrlKey === true) || 
        (e.keyCode == 67 && e.ctrlKey === true) ||
        (e.keyCode == 86 && e.ctrlKey === true) ||
        (e.keyCode == 88 && e.ctrlKey === true) ||
        // –†–∞–∑—Ä–µ—à–∞–µ–º: —Ü–∏—Ñ—Ä—ã, —Å—Ç—Ä–µ–ª–∫–∏
        (e.keyCode >= 48 && e.keyCode <= 57) ||
        (e.keyCode >= 96 && e.keyCode <= 105) ||
        (e.keyCode >= 37 && e.keyCode <= 40)) {
      return;
    }
    e.preventDefault();
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('.product-image img');
    images.forEach(img => {
      img.onerror = function() {
        this.style.display = 'none';
        const noImage = this.nextElementSibling;
        if (noImage && noImage.classList.contains('no-image')) {
          noImage.style.display = 'flex';
        }
      };
    });
  });
</script>

<%- include("partials/footer") %>